# ガンスリンガー方式バトル マッチングシステム

ガンスリンガー方式のマッチングを管理するためのシステムです。主にポケモンカードバトル大会向けに設計しており、Google Apps Script (GAS) とスプレッドシートで動作します。

## 機能一覧

- プレイヤー管理
  - プレイヤー登録処理
  - プレイヤー休憩・復帰処理
  - プレイヤードロップアウト処理
- 自動マッチング（再戦回避機能付き）
  - 勝者優先マッチング（勝数が多い順、同勝数なら先着順）
  - 過去対戦相手の自動記録と再戦回避
  - 卓番号の自動管理と再利用
- 対戦結果記録
  - 勝敗統計の自動更新（勝数・敗数・試合数）
  - 対戦履歴の記録

## プレイヤーの状態遷移

1. 待機: マッチングを待ちます。
2. 対戦中: 対戦が進行中です。
3. 休憩: 一時的に対戦から離脱します（復帰可能です）。
4. 終了: ドロップアウト済みで復帰はできません。

## 主な特徴

### 再戦回避システム

- 過去に対戦した相手との再戦を自動的に回避します。
- 全員が過去対戦者の場合はマッチングを成立させず待機を継続します。

### 勝者優先マッチング

- 勝数が多いプレイヤーを優先的にマッチングします。
- 同じ勝数の場合は先着順（最終対戦時刻が古い方）を優先します。

### 卓番号管理

- 対戦終了後も卓番号を保持し、勝者が同じ卓を再利用します。
- 最大卓数は1～200の範囲で動的に設定できます（デフォルト: 50卓）。
- カスタムメニューから現在の設定卓数を確認・変更できます。
- 物理的な卓配置と連動した運用が可能です。

### 自動統計管理

- 勝数・敗数・試合数を自動で集計します。
- 対戦履歴は詳細に記録されます。
- 最終対戦時刻は自動で更新されます。

## セットアップ方法

### 1. スプレッドシートの準備

1. [Google スプレッドシート](https://sheets.google.com/) を新規作成します。
2. 「拡張機能」→「Apps Script」を開きます。
3. 本リポジトリの各 `.js` ファイルをスクリプトエディタにコピーします。
4. スクリプトを保存してスプレッドシートに戻します。
5. ページを更新すると「🃏 ガンスリンガーマッチング」メニューが表示されます。

### 2. 初期設定

1. カスタムメニューから「⚙️ シートの初期設定」を実行してください。
2. 3つのシート（プレイヤー、対戦履歴、マッチング）が自動で作成されます。

### 3. 大会運用の開始

1. カスタムメニューから「➕ プレイヤーを追加する」でプレイヤーを登録します。
2. 待機プレイヤーが2人以上になると自動でマッチングが開始されます。
3. 対戦終了後は「✅ 対戦結果の記録」で勝者を記録してください。
4. 必要に応じて休憩・復帰・ドロップアウト処理を実行してください。

### 表示形式について

- 対戦中の経過時間は内部でミリ秒差を計算し、HH:mm:ss 形式で表示します（例: 00:03:42）。
  これは GAS の日時フォーマット差異によるズレを避けるため、ミリ秒から直接フォーマットする実装にしています。

### トリガー（経過時間更新）

- **⏱️ 経過時間更新の開始**: 対戦中の卓の経過時間を1分ごとに更新するトリガーを開始します。
- **⏹️ 経過時間更新の停止**: 開始済みの経過時間トリガーを停止します。

注意: 最大卓数を減らす場合は、現在マッチングシートで使用中の最大卓番号より小さい値には設定できません。これは運用中の卓が割り当てられたままになることを防ぐための保護です。

## 使用方法

### カスタムメニュー操作

- **➕ プレイヤーを追加する**: 新しいプレイヤーを登録します（自動IDで採番されます）。
- **✅ 対戦結果の記録**: 勝者を指定して対戦を終了し、統計を自動で更新します。
- **☕ プレイヤーを休憩にする**: 一時的に対戦から離脱させます（後で復帰できます）。
- **↩️ 休憩から復帰させる**: 休憩中のプレイヤーを待機状態に戻します（自動マッチングが発動します）。
- **❌ プレイヤーをドロップアウトさせる**: 大会から完全に退出させます（復帰不可です）。
- **🔧 対戦結果の修正**: 誤って記録した対戦結果を修正できます。
- **⏱️ 経過時間更新の開始**: 対戦中の卓の経過時間を1分ごとに更新するトリガーを開始します。
- **⏹️ 経過時間更新の停止**: 対戦時間更新のトリガーを停止します。
- **⚙️ 最大卓数の設定**: 使用する卓の最大数を設定します（1～200、デフォルト: 50）。

### データシート構成

システムは以下の3つのシートを使用します。

1. **プレイヤーシート**: プレイヤーマスタ
   - プレイヤーID、名前、勝敗数、試合数、参加状況、最終対戦時刻を管理します。

2. **対戦履歴シート**: 完了した対戦の記録
   - 対戦の時刻、卓番号、両プレイヤーの ID と名前、勝者名、対戦 ID などを記録します。

3. **マッチングシート**: 現在進行中の対戦
   - 卓番号、両プレイヤーの ID・名前、対戦開始時刻、経過時間を表示します（経過時間は HH:mm:ss 表示）。

## よくある質問

### Q. 最大何人まで管理できますか？

A. プレイヤー数に制限はありませんが、50人以上での運用を想定した最適化を行っています。

### Q. 卓数の上限は変更できますか？

A. カスタムメニューの「⚙️ 最大卓数の設定」から1～200の範囲で設定できます（デフォルト: 50卓）。

### Q. 対戦結果を間違えて記録してしまいました

A. カスタムメニューの「🔧 対戦結果の修正」から修正できます。対戦IDを指定して新しい勝者を入力してください。

### Q. プレイヤーが一時的に離席する場合は？

A. 「☕ プレイヤーを休憩にする」を使用してください。復帰時は「↩️ 休憩から復帰させる」で待機状態に戻ります。

### Q. 開発に参加したいのですが

A. [.github/copilot-instructions.md](.github/copilot-instructions.md) に開発者向けの詳細情報があります。Pull Requestも歓迎します！

## 作者

springOK

## ライセンス

MIT License

Copyright (c) 2025 springOK

このソフトウェアはMITライセンスの下で公開されています。
詳細は [LICENSE](LICENSE) ファイルを参照してください。
